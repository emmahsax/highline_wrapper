name: GitLeaks

# Override desired times to run this workflow
on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

# Override environment variables as needed
env:
  GITLEAKS_CONFIG_COMMITS: "[]" # A list of commits to ignore when running GitLeaks
  GITLEAKS_CONFIG_REGEXES: "[]" # A list of regexes or secrets to ignore when running GitLeaks

###########################################################
### DO NOT EDIT BELOW â€“ TEXT IS AUTOMATICALLY GENERATED ###
###########################################################

jobs:
  default:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set GitLeaks Config
        run: |
          if [[ ${{ github.REF }} == 'refs/heads'* ]]; then # This is a branch, not a pull request
            CURRENT_COMMIT="${{ github.SHA }}"
          else
            CURRENT_COMMIT="${{ github.EVENT.PULL_REQUEST.HEAD.SHA }}"
          fi
          echo "COMMITS=$(
            git rev-list $CURRENT_COMMIT ^origin/main | sed 's/^\|$//g' | paste -sd, -
          )" >> $GITHUB_ENV
          echo "Title = 'GitLeaks Allowlist'" >> ${{ github.WORKSPACE }}/gitleaks.toml
          echo "[allowlist]" >> ${{ github.WORKSPACE }}/gitleaks.toml
          echo "  commits = ${{ env.GITLEAKS_CONFIG_COMMITS }}" >> ${{ github.WORKSPACE }}/gitleaks.toml
          echo "  regexes = ${{ env.GITLEAKS_CONFIG_REGEXES }}" >> ${{ github.WORKSPACE }}/gitleaks.toml
      - name: GitLeaks
        run: |
          COMMAND="gitleaks --verbose --additional-config='/app/gitleaks.toml' --path='/app'"
          if [ ${{ github.REF }} != 'refs/heads/main' ]; then
            COMMAND="${COMMAND} --commits='${{ env.COMMITS }}'"
          fi
          docker pull zricethezav/gitleaks
          docker run --rm -v $(pwd):/app -i --entrypoint /bin/bash zricethezav/gitleaks -c "$COMMAND"
